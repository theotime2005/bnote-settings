name: Update .nvmrc to latest Node.js

on:
  schedule:
    - cron: '0 3 * * 1' # Tous les lundis Ã  3h UTC
  workflow_dispatch:

jobs:
  update-nvmrc:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: setup node
        uses: actions/setup-node@v6
        with:
          node-version: node

      - name: Check if node version is up to date
        id: check_version
        run: |
          current_version=$(cat .nvmrc)
          latest_version=$(node -v | sed 's/^v//')
          echo "current_version=$current_version" >> $GITHUB_ENV
          echo "latest_node_version=$latest_version" >> $GITHUB_ENV
          if [ "$current_version" = "$latest_version" ]; then
            echo "Node.js version is up to date."
            exit 0
          else
            echo "Node.js version is outdated. Current: $current_version, Latest: $latest_version"
          fi

      - name: Create new branch with node-version
        run: |
          git config --local user.name "github-actions-updater"
          git config --local user.email "github-actions-updater@github.com"
          git checkout -b update-nvmrc-${{ env.latest_node_version }}

      - name: Update .nvmrc file
        run: |
          echo "${{ env.latest_node_version }}" > .nvmrc

      - name: Commit and push file
        run: |
          git add .nvmrc
          git commit -m "Update .nvmrc to Node.js ${{ env.latest_node_version }}"
          git push --set-upstream origin update-nvmrc-${{ env.latest_node_version }}


      - name: Create pull request with gh
        run: |
          pr_url=$(gh pr create --title "bump: Update .nvmrc to Node.js ${{ env.latest_node_version }}" --body "This PR updates the .nvmrc file to the latest Node.js version ${{ env.latest_node_version }}." --base main --head update-nvmrc-${{ env.latest_node_version }} --json url --jq '.url')
          echo "PR_URL=$pr_url" >> "$GITHUB_ENV"
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Enable auto merge
        run: |
          gh pr merge "$PR_URL" --auto -s -d
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
